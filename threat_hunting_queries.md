# ðŸ•µï¸ Threat Hunting Queries
**Date Generated:** 2026-01-05 14:58:13

---

This document contains automated threat hunting queries generated by the Gemini API.

---

## ðŸ’» SPL Queries

### Query 1: Network Connections to Exfiltration IP

```splunk
(index=network OR index=aws sourcetype IN (aws:cloudwatch:vpcflow, pan:traffic, cisco:asa, squid:access, stream:ip)) OR (index=windows sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational EventCode=3)
| where dest_ip="103.11.190.99" OR src_ip="103.11.190.99"
| stats count by _time, src_ip, dest_ip, dest_port, protocol, bytes_out, bytes_in, user, host, action
| sort -_time
```

### Query 2: TFTP Process Execution and Exfiltration Command

```splunk
(index=windows sourcetype=WinEventLog:Security EventCode=4688) OR (index=windows sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational EventCode=1)
| search (process_name="tftp.exe" OR Image="*\\tftp.exe") AND CommandLine="* -p -l * /tmp/enc_config.xml* 103.11.190.99*"
| table _time, host, user, ParentProcessName, process_name, CommandLine, ProcessId, ParentProcessId
```

### Query 3: File System Activity on Sensitive WatchGuard Configuration

```splunk
(index=windows sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational EventCode IN (11, 23)) OR (index=linux sourcetype=auditd OR sourcetype=fsevents)
| search FilePath="/etc/wg/config.xml" OR TargetFilename="/tmp/enc_config.xml"
| stats count by _time, host, user, ProcessName, EventCode, Image, TargetFilename, FilePath, action
| sort -_time
```

### Query 4: TFTP Network Traffic (UDP Port 69)

```splunk
(index=network OR index=aws sourcetype IN (aws:cloudwatch:vpcflow, pan:traffic, cisco:asa, stream:ip))
| search (dest_port=69 AND protocol="udp") OR (src_port=69 AND protocol="udp")
| stats count by _time, src_ip, dest_ip, dest_port, protocol, bytes_out, bytes_in, action, app, orig_host, dest_host
| sort -_time
```

### Query 5: Unusual Successful Logins to Network Edge Devices

```splunk
index=network sourcetype IN (pan:traffic, cisco:asa, fortigate:traffic, cisco:ios, paloalto:config) (dest_port=22 OR dest_port=23 OR dest_port=80 OR dest_port=443 OR dest_port=8080 OR dest_port=8443) action=allow
| search (device_type="router" OR device_type="firewall" OR device_type="vpn")
| stats count(eval(action="allow")) as successful_logins by _time, src_ip, dest_ip, dest_port, user, dvc
| `asset_lookup(src_ip, is_private)`
| search is_private=0 AND NOT [| inputlookup trusted_external_ips.csv | fields ip]
| where successful_logins > 0
| `comment("Review successful logins to network management interfaces from untrusted external IPs")`
| sort -_time
```

### Query 6: Credential Replay Attacks - Multiple Failed Logins from External IPs

```splunk
(index=authentication OR index=aws sourcetype IN (WinEventLog:Security, aws:cloudtrail, Okta_syslog, Azure_AD_SigninLogs))
| search authentication_result=failure
| `asset_lookup(src_ip, is_private)`
| search is_private=0 AND NOT [| inputlookup trusted_external_ips.csv | fields ip]
| rare limit=100 src_ip, user
| stats count, values(user) as attempted_users by src_ip
| where count > 5 AND mvcount(attempted_users) > 1
| `comment("Identifies external IPs attempting multiple failed logins across different user accounts, indicative of credential stuffing/replay.")`
```

### Query 7: Credential Replay Attacks - Successful Login from New/Rare IP after Device Compromise

```splunk
(index=authentication OR index=aws sourcetype IN (WinEventLog:Security, aws:cloudtrail, Okta_syslog, Azure_AD_SigninLogs))
| search authentication_result=success
| `asset_lookup(src_ip, is_private)`
| search is_private=0
| eventstats min(_time) as first_seen_time by user, src_ip
| where _time - first_seen_time < 3600 AND (_time - first_seen_time > 0)
| `comment("This query identifies successful logins from a new source IP for a given user. This is a heuristic and requires tuning with baselines.")`
| stats count by _time, user, src_ip, dest_ip, authentication_result
| sort -_time
| `comment("Requires historical baseline of user IP activity to be truly effective. Look for a user logging in from an IP not seen within a long historical period (e.g., 90 days).")`
```

### Query 8: AWS VPC Flow Logs - Persistent Connections to Compromised EC2 Instances

```splunk
index=aws sourcetype=aws:cloudwatch:vpcflow action=ACCEPT
| eval duration_minutes = (end - start) / 60
| stats sum(bytes_in) as total_bytes_in, sum(bytes_out) as total_bytes_out, count as connection_count, max(duration_minutes) as max_duration_minutes, values(src_ip) as source_ips, values(dest_port) as dest_ports by dest_ip
| where connection_count > 100 AND max_duration_minutes > 60 AND is_private(dest_ip) AND NOT is_private(source_ips)
| `comment("Identifies EC2 instances with high number of connections or long-duration connections from external (non-private) IPs, potentially indicating persistent access.")`
| sort -connection_count
```

### Query 9: Python Script Execution with Suspicious Keywords

```splunk
(index=windows sourcetype=WinEventLog:Security EventCode=4688) OR (index=windows sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational EventCode=1) OR (index=linux sourcetype=auditd OR sourcetype=osquery)
| search (process_name="python.exe" OR Image="*\\python.exe" OR comm="python")
| search CommandLine="*import subprocess*" OR CommandLine="*import os*" OR CommandLine="*cryptography.fernet*"
| table _time, host, user, ParentProcessName, process_name, CommandLine, ProcessId, ParentProcessId
| `comment("Looks for Python execution involving suspicious libraries and commands identified in the report payload.")`
```

---

## ðŸ’» KQL Queries

### Log Sources for Threat Hunting

*   **Azure Active Directory Logs:** `SigninLogs`, `AuditLogs`
*   **Azure Network Security Group Flow Logs:** `AzureNetworkAnalytics_CL`
*   **Generic Security Logs (Firewalls, Proxies, Routers):** `CommonSecurityLog` (for devices sending Syslog/CEF)
*   **Linux System Logs:** `Syslog` (for process activity, file changes via auditd, general system events on network appliances)
*   **Microsoft Defender for Endpoint (MDE) Logs:** `DeviceProcessEvents`, `DeviceNetworkEvents`, `DeviceFileEvents` (for Linux/Windows hosts monitored by MDE)
*   **AWS Logs (if ingested into Sentinel):** `AWSCloudTrail`, `AWSVPCFlow`

### Query 1: TFTP Exfiltration to Known Actor IP (Network Flows and Firewall Logs)

```kql
(union isfuzzy=true AzureNetworkAnalytics_CL, CommonSecurityLog, AWSVPCFlow
| where TimeGenerated > ago(30d)
| where (isnotempty(DestIP_s) and DestIP_s == "103.11.190.99" and L4Protocol_s == "UDP" and DestPort_d == 69) // AzureNetworkAnalytics_CL
    or (isnotempty(DestinationIP) and DestinationIP == "103.11.190.99" and Protocol == "UDP" and DestinationPort == 69) // CommonSecurityLog
    or (isnotempty(dstip) and dstip == "103.11.190.99" and protocol_name == "UDP" and dstport == 69) // AWSVPCFlow
)
| summarize count() by bin(TimeGenerated, 1h), SrcIP_s, DestinationIP, dstip // Adjust based on which table matched
| extend
    SourceIp = coalesce(SrcIP_s, SourceIP, srcip),
    DestinationIp = coalesce(DestIP_s, DestinationIP, dstip)
| project TimeGenerated, SourceIp, DestinationIp, count_
| order by TimeGenerated desc
```

### Query 2: TFTP Process Execution on Endpoints

```kql
union isfuzzy=true DeviceProcessEvents, Syslog
| where TimeGenerated > ago(30d)
| where FileName =~ "tftp"
    and (ProcessCommandLine contains "-p" or ProcessCommandLine contains "-l") // Common TFTP upload/put arguments
| extend
    InitiatingProcess = case(
        _is_column_present("InitiatingProcessFileName"), InitiatingProcessFileName,
        _is_column_present("ParentProcessName"), ParentProcessName,
        ""
    ),
    InitiatingProcessCommandLine = case(
        _is_column_present("InitiatingProcessCommandLine"), InitiatingProcessCommandLine,
        _is_column_present("ParentProcessCommandLine"), ParentProcessCommandLine,
        ""
    )
| project TimeGenerated, DeviceName, InitiatingProcess, InitiatingProcessCommandLine, ProcessCommandLine, AccountName, RemoteIP, RemotePort
| order by TimeGenerated desc
```

### Query 3: Deletion of Temporary Encrypted Configuration File

```kql
union isfuzzy=true DeviceFileEvents, Syslog
| where TimeGenerated > ago(30d)
| where (ActionType == "FileDeleted" and FolderPath contains "/tmp/" and FileName =~ "enc_config.xml") // MDE
    or (SourceSystem == "Linux" and Event contains "/tmp/enc_config.xml" and Event contains "delete") // Syslog, heuristic
| project TimeGenerated, DeviceName, InitiatingProcessCommandLine, FileName, FolderPath, SHA256, InitiatingProcessAccountName
| order by TimeGenerated desc
```

### Query 4: Credential Replay Attempts from Known Actor IP

```kql
union isfuzzy=true SigninLogs, AWSCloudTrail
| where TimeGenerated > ago(30d)
| where IPAddress == "103.11.190.99" // Known actor IP
    or SourceIPAddress == "103.11.190.99" // AWSCloudTrail SourceIPAddress
| where (ResultType == "50125" or ResultType == "50053" or ResultType == "50057") // Azure AD failed authentication codes (Invalid Username/Password, Account Locked, Account Disabled)
    or (ErrorCode == "Client.InvalidCredentials" or ErrorCode == "InvalidSignatureException") // AWS failed authentication
| extend
    AuthenticationStatus = case(
        _is_column_present("ResultType"), ResultType,
        _is_column_present("ErrorCode"), ErrorCode,
        ""
    ),
    TargetUser = case(
        _is_column_present("UserPrincipalName"), UserPrincipalName,
        _is_column_present("UserIdentity_userName"), UserIdentity_userName,
        ""
    ),
    SourceIp = case(
        _is_column_present("IPAddress"), IPAddress,
        _is_column_present("SourceIPAddress"), SourceIPAddress,
        ""
    )
| project TimeGenerated, TargetUser, SourceIp, AuthenticationStatus, UserAgent, OperationName, Location
| order by TimeGenerated desc
```

### Query 5: Inbound Connections to Network Appliance Management Ports from External IPs

```kql
(union isfuzzy=true AzureNetworkAnalytics_CL, CommonSecurityLog, AWSVPCFlow
| where TimeGenerated > ago(30d)
// Filter for common management ports and exclude internal network ranges for destination
| where (DestPort_d in (22, 23, 80, 443, 8443, 8080) and isnotempty(SrcIP_s) and isipv4(SrcIP_s) and not(ipv4_is_private(SrcIP_s)) and isnotempty(DestIP_s) and isipv4(DestIP_s) and not(ipv4_is_private(DestIP_s))) // AzureNetworkAnalytics_CL
    or (DestinationPort in (22, 23, 80, 443, 8443, 8080) and isnotempty(SourceIP) and isipv4(SourceIP) and not(ipv4_is_private(SourceIP)) and isnotempty(DestinationIP) and isipv4(DestinationIP) and not(ipv4_is_private(DestinationIP))) // CommonSecurityLog
    or (dstport in (22, 23, 80, 443, 8443, 8080) and isnotempty(srcip) and isipv4(srcip) and not(ipv4_is_private(srcip)) and isnotempty(dstip) and isipv4(dstip) and not(ipv4_is_private(dstip))) // AWSVPCFlow
// Add specific filtering for network appliance IPs/subnets if known, e.g., and DestIP_s in ("<Appliance_IP_1>", "<Appliance_IP_2>")
| summarize ConnectionCount = count() by bin(TimeGenerated, 1h), coalesce(SrcIP_s, SourceIP, srcip), coalesce(DestIP_s, DestinationIP, dstip), coalesce(DestPort_d, DestinationPort, dstport)
| where ConnectionCount > 5 // Adjust threshold based on environment baseline
| extend
    SourceIp = coalesce(SrcIP_s, SourceIP, srcip),
    DestinationIp = coalesce(DestIP_s, DestinationIP, dstip),
    DestinationPort = coalesce(DestPort_d, DestinationPort, dstport)
| project TimeGenerated, SourceIp, DestinationIp, DestinationPort, ConnectionCount
| order by TimeGenerated desc
```

### Query 6: Python Script Spawning TFTP Process (Heuristic)

```kql
DeviceProcessEvents
| where TimeGenerated > ago(30d)
| where InitiatingProcessFileName =~ "python" or InitiatingProcessCommandLine contains "python"
| where FileName =~ "tftp"
| where ProcessCommandLine contains "-p" or ProcessCommandLine contains "-l"
| project TimeGenerated, DeviceName, InitiatingProcessCommandLine, ProcessCommandLine, AccountName, RemoteIP, RemotePort, InitiatingProcessParentFileName, InitiatingProcessCreationTime
| order by TimeGenerated desc
```

---

## ðŸ’» AQL Queries

### Query 1: IOC - Exfiltration IP `103.11.190.99` Activity

```sql
SELECT
  QIDNAME(qid) AS "Event Name",
  STARTEVENT AS "Start Time",
  LOGSOURCENAME(logsourceid) AS "Log Source",
  sourceip AS "Source IP",
  destinationip AS "Destination IP",
  sourceport AS "Source Port",
  destinationport AS "Destination Port",
  protocol AS "Protocol",
  username AS "Username",
  payload AS "Raw Payload"
FROM events
WHERE
  (destinationip = '103.11.190.99' OR sourceip = '103.11.190.99')
ORDER BY
  STARTEVENT DESC
LIMIT 100
```

### Query 2: TTP - TFTP Exfiltration to IOC IP

```sql
SELECT
  QIDNAME(qid) AS "Event Name",
  STARTEVENT AS "Start Time",
  LOGSOURCENAME(logsourceid) AS "Log Source",
  sourceip AS "Source IP",
  destinationip AS "Destination IP",
  sourceport AS "Source Port",
  destinationport AS "Destination Port",
  protocol AS "Protocol",
  username AS "Username",
  payload AS "Raw Payload"
FROM events
WHERE
  destinationip = '103.11.190.99' AND
  destinationport = '69' AND
  protocol = 'UDP' AND
  (category ILIKE 'Network Flow' OR category ILIKE 'Firewall' OR category ILIKE 'Traffic')
ORDER BY
  STARTEVENT DESC
LIMIT 100
```

### Query 3: TTP - TFTP Process Execution and File Deletion on Endpoints

```sql
SELECT
  QIDNAME(qid) AS "Event Name",
  STARTEVENT AS "Start Time",
  LOGSOURCENAME(logsourceid) AS "Log Source",
  sourceip AS "Source IP",
  destinationip AS "Destination IP",
  username AS "Username",
  LOWER(STR(processname)) AS "Process Name",
  LOWER(STR(commandline)) AS "Command Line",
  LOWER(STR(filename)) AS "File Name",
  LOWER(STR(filepath)) AS "File Path",
  payload AS "Raw Payload"
FROM events
WHERE
  (
    LOWER(STR(commandline)) ILIKE '%tftp%' AND LOWER(STR(commandline)) ILIKE '%-p%' AND LOWER(STR(commandline)) ILIKE '%-l%' AND (LOWER(STR(commandline)) ILIKE '%/tmp/enc_config.xml%' OR LOWER(STR(commandline)) ILIKE '%103.11.190.99%')
  ) OR
  (
    LOWER(STR(filename)) ILIKE 'enc_config.xml' AND LOWER(STR(filepath)) ILIKE '/tmp%' AND category ILIKE '%file delete%'
  ) OR
  (
    LOWER(STR(filename)) ILIKE 'config.xml' AND LOWER(STR(filepath)) ILIKE '/etc/wg%' AND category ILIKE '%file read%'
  )
ORDER BY
  STARTEVENT DESC
LIMIT 100
```

### Query 4: TTP - Suspicious Login Attempts to Network Edge Devices

```sql
SELECT
  QIDNAME(qid) AS "Event Name",
  STARTEVENT AS "Start Time",
  LOGSOURCENAME(logsourceid) AS "Log Source",
  sourceip AS "Source IP",
  username AS "Username",
  destinationip AS "Destination IP",
  destinationport AS "Destination Port",
  payload AS "Raw Payload"
FROM events
WHERE
  (
    (QIDNAME(qid) ILIKE '%login success%' OR QIDNAME(qid) ILIKE '%authentication success%')
    AND NOT sourceip IN ('<internal_networks>', '<trusted_vpn_ranges>')
    AND destinationport IN ('22', '23', '80', '443', '8080', '8443', '10000', '20000', '8888') -- Common management ports
    AND (
      (logsourcegroup ILIKE '%router%' OR logsourcegroup ILIKE '%firewall%' OR logsourcegroup ILIKE '%vpn%' OR logsourcegroup ILIKE '%load balancer%')
      OR
      (categorynormalized = 'Authentication' AND categorydevicegroup = 'Network Device') -- Adjust based on QRadar parsing
    )
  )
  OR
  (
    (QIDNAME(qid) ILIKE '%login failed%' OR QIDNAME(qid) ILIKE '%authentication failed%')
    AND destinationport IN ('22', '23', '80', '443', '8080', '8443', '10000', '20000', '8888')
    AND (
      (logsourcegroup ILIKE '%router%' OR logsourcegroup ILIKE '%firewall%' OR logsourcegroup ILIKE '%vpn%' OR logsourcegroup ILIKE '%load balancer%')
      OR
      (categorynormalized = 'Authentication' AND categorydevicegroup = 'Network Device')
    )
  )
GROUP BY
  sourceip, destinationip, username, QIDNAME(qid)
HAVING
  COUNT(*) > 5 -- Adjust threshold for repeated attempts
ORDER BY
  COUNT(*) DESC
LIMIT 100
```
*NOTE: Replace `<internal_networks>` and `<trusted_vpn_ranges>` with your actual network definitions or reference sets.*

### Query 5: TTP - Credential Replay Attempts Against Online Services

```sql
SELECT
  QIDNAME(qid) AS "Event Name",
  STARTEVENT AS "Start Time",
  LOGSOURCENAME(logsourceid) AS "Log Source",
  sourceip AS "Source IP",
  username AS "Username",
  destinationip AS "Destination IP",
  "Event Count" AS "Count"
FROM events
WHERE
  (categorynormalized = 'Authentication' AND categorydevicegroup = 'Web Server') -- For web applications/online services
  OR
  (categorynormalized = 'Authentication' AND categorydevicegroup = 'Directory Service') -- For AD/LDAP based services
  OR
  (categorynormalized = 'Authentication' AND categorydevicegroup = 'Identity and Access Management') -- For IdP services like Okta
  OR
  (QIDNAME(qid) ILIKE '%login%' AND (logsourcegroup ILIKE '%web app%' OR logsourcegroup ILIKE '%idp%'))
  AND NOT sourceip IN ('<internal_networks>', '<trusted_vpn_ranges>')
GROUP BY
  sourceip, username, QIDNAME(qid), destinationip
HAVING
  COUNT(*) > 5 -- Adjust threshold for frequent attempts
ORDER BY
  "Event Count" DESC
LIMIT 100
```
*NOTE: Replace `<internal_networks>` and `<trusted_vpn_ranges>` with your actual network definitions or reference sets.*

### Query 6: TTP - Network Edge Device Configuration Changes

```sql
SELECT
  QIDNAME(qid) AS "Event Name",
  STARTEVENT AS "Start Time",
  LOGSOURCENAME(logsourceid) AS "Log Source",
  sourceip AS "Source IP",
  username AS "Username",
  destinationip AS "Destination IP",
  payload AS "Raw Payload"
FROM events
WHERE
  (
    QIDNAME(qid) ILIKE '%configuration change%' OR
    QIDNAME(qid) ILIKE '%config changed%' OR
    QIDNAME(qid) ILIKE '%setting changed%' OR
    (category ILIKE '%configuration%' AND category ILIKE '%change%')
  )
  AND
  (
    logsourcegroup ILIKE '%router%' OR
    logsourcegroup ILIKE '%firewall%' OR
    logsourcegroup ILIKE '%vpn%' OR
    logsourcegroup ILIKE '%load balancer%' OR
    categorydevicegroup = 'Network Device'
  )
ORDER BY
  STARTEVENT DESC
LIMIT 100
```

### Query 7: TTP - AWS CloudTrail Security Group/ACL Modifications

```sql
SELECT
  QIDNAME(qid) AS "Event Name",
  STARTEVENT AS "Start Time",
  LOGSOURCENAME(logsourceid) AS "Log Source",
  sourceip AS "Source IP",
  username AS "Username",
  aws_eventname AS "AWS Event Name",
  aws_sourceregion AS "AWS Region",
  STR(aws_eventdata) AS "Event Data"
FROM events
WHERE
  logsourcegroup ILIKE '%aws cloudtrail%' AND
  aws_eventname IN (
    'AuthorizeSecurityGroupIngress',
    'AuthorizeSecurityGroupEgress',
    'RevokeSecurityGroupIngress',
    'RevokeSecurityGroupEgress',
    'CreateNetworkAclEntry',
    'ReplaceNetworkAclEntry',
    'DeleteNetworkAclEntry',
    'ModifySecurityGroupRules'
  )
ORDER BY
  STARTEVENT DESC
LIMIT 100
```

### Query 8: TTP - Suspicious Packet Capture Process Execution

```sql
SELECT
  QIDNAME(qid) AS "Event Name",
  STARTEVENT AS "Start Time",
  LOGSOURCENAME(logsourceid) AS "Log Source",
  sourceip AS "Source IP",
  username AS "Username",
  LOWER(STR(processname)) AS "Process Name",
  LOWER(STR(commandline)) AS "Command Line",
  payload AS "Raw Payload"
FROM events
WHERE
  (
    LOWER(STR(processname)) IN ('tcpdump', 'windump', 'wireshark', 'dumpcap', 'pkttest')
    OR
    LOWER(STR(commandline)) ILIKE '%tcpdump%'
    OR
    LOWER(STR(commandline)) ILIKE '%windump%'
    OR
    LOWER(STR(commandline)) ILIKE '%wireshark%'
  )
  AND (categorydevicegroup = 'Endpoint' OR categorydevicegroup = 'Server')
ORDER BY
  STARTEVENT DESC
LIMIT 100
```

---

## ðŸ’» UDM Queries

### Query 1: IOC - Network Connections to TFTP Exfiltration Server

```udm
metadata.event_type = "NETWORK_CONNECTION"
and network.target.ip = "103.11.190.99"
```

### Query 2: IOC - TFTP Exfiltration Command Line Execution

```udm
metadata.event_type = "PROCESS_LAUNCH"
and target.process.command_line contains "tftp"
and target.process.command_line contains "/tmp/enc_config.xml"
and target.process.command_line contains "103.11.190.99"
```

### Query 3: IOC - WatchGuard Configuration File Access or Modification

```udm
metadata.event_type = "FILE_CHANGE"
and target.file.full_path in ("/etc/wg/config.xml", "/tmp/enc_config.xml")
```

### Query 4: TTP - Suspicious Outbound TFTP Activity

```udm
metadata.event_type = "NETWORK_CONNECTION"
and network.protocol = "UDP"
and network.target.port = 69
and network.direction = "OUTBOUND"
```

### Query 5: TTP - Credential Replay Attempts against Authentication Endpoints

```udm
metadata.event_type = "USER_LOGIN"
and (security_result.action = "DENY" or security_result.action = "ALLOW")
// Refine by unusual principal.ip, geographic location, or velocity of attempts against multiple users/services.
// Example for AWS failed logins:
and metadata.vendor_name = "AWS"
and principal.service.name = "ConsoleLogin"
and security_result.action = "DENY"
```

### Query 6: TTP - Abnormal Outbound Network Egress from AWS EC2 Instances

```udm
metadata.event_type = "NETWORK_CONNECTION"
and metadata.vendor_name = "AWS"
and principal.resource.cloud.resource_type = "EC2_INSTANCE"
and network.direction = "OUTBOUND"
// Consider adding filters for unusual target ports, uncommon protocols, or large data transfers if flow logs support byte counts.
// Further hunting could involve grouping by principal.resource.name and network.target.ip to identify sustained connections or high volume.
```

### Query 7: TTP - External Administrative Access to Network Edge Devices

```udm
metadata.event_type = "NETWORK_CONNECTION"
and (target.resource.type = "NETWORK_DEVICE" or target.asset.labels contains "network_edge")
and network.direction = "INBOUND"
and network.target.port in (22, 23, 80, 443, 8080, 8443, 161, 3389) // Common management ports (SSH, Telnet, HTTP/S, SNMP, RDP)
and principal.ip.is_external = true // Assuming 'is_external' field or similar logic
```

### Query 8: TTP - Python Script Reading/Writing Configuration Files with Network Activity Potential

```udm
metadata.event_type in ("PROCESS_LAUNCH", "FILE_CHANGE", "NETWORK_CONNECTION")
and principal.process.file.file_name ilike "python%"
and (target.file.full_path contains "/etc/wg/config.xml"
     or target.file.full_path contains "/tmp/enc_config.xml"
     or (metadata.event_type = "NETWORK_CONNECTION" and network.direction = "OUTBOUND"))
```

---

